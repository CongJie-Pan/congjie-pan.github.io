#!/bin/bash
#
# ç”¨æ–¼å°‡ç¶²ç«™éƒ¨ç½²åˆ° GitHub Pages çš„è…³æœ¬
# åŸ·è¡Œæ–¹å¼: bin/deploy [--user]
#
# [--user] é¸é …è¡¨ç¤ºéƒ¨ç½²åˆ°å€‹äºº GitHub Pages
# ä¸å¸¶åƒæ•¸å‰‡é è¨­éƒ¨ç½²åˆ°å°ˆæ¡ˆ GitHub Pages

# åš´æ ¼æ¨¡å¼ï¼Œé¿å…éŒ¯èª¤
set -e

# ç²å–è…³æœ¬æ‰€åœ¨ç›®éŒ„çš„ä¸Šä¸€å±¤ç›®éŒ„ï¼ˆå³å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼‰
SCRIPT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT_PATH="$(dirname "$SCRIPT_PATH")"

# é€²å…¥å°ˆæ¡ˆç›®éŒ„
cd "$REPO_ROOT_PATH"

# è¨­å®šè®Šæ•¸
GITHUB_USERNAME=$(git config --get remote.origin.url | cut -d: -f2 | cut -d/ -f1)
GITHUB_REPONAME=$(basename -s .git `git config --get remote.origin.url`)
BRANCH="master"

# ç›®æ¨™åˆ†æ”¯ï¼ˆå–æ±ºæ–¼åƒæ•¸ï¼‰
if [[ $1 == '--user' ]]; then
  DEPLOY_BRANCH="master"
  echo "ğŸš€ æº–å‚™éƒ¨ç½²åˆ°å€‹äºº GitHub Pages ..."
else
  DEPLOY_BRANCH="gh-pages"
  echo "ğŸš€ æº–å‚™éƒ¨ç½²åˆ°å°ˆæ¡ˆ GitHub Pages ..."
fi

# ç¢ºä¿ç•¶å‰åˆ†æ”¯æ˜¯æœ€æ–°çš„
echo "ğŸ“Œ æ›´æ–°æœ¬åœ°ä»£ç¢¼..."
git pull origin $BRANCH || { echo "âŒ ç„¡æ³•æ›´æ–°æœ¬åœ°ä»£ç¢¼ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ–Gitè¨­å®š"; exit 1; }

# ç¢ºèªæ‰€æœ‰æ›´æ”¹å·²ç¶“æäº¤
if [[ -n $(git status -s) ]]; then
  echo "âš ï¸ æ‚¨æœ‰æœªæäº¤çš„æ›´æ”¹ï¼Œè«‹å…ˆæäº¤å¾Œå†éƒ¨ç½²"
  echo "æœªæäº¤çš„æ–‡ä»¶:"
  git status -s
  exit 1
fi

# æ§‹å»ºç¶²ç«™
echo "ğŸ”¨ æ§‹å»ºç¶²ç«™..."
bundle exec jekyll build || { echo "âŒ æ§‹å»ºå¤±æ•—ï¼è«‹æª¢æŸ¥æ‚¨çš„Jekyllè¨­å®š"; exit 1; }

# ç¢ºä¿ _site ç›®éŒ„å­˜åœ¨
if [ ! -d "_site" ]; then
  echo "âŒ _site ç›®éŒ„ä¸å­˜åœ¨ï¼Œæ§‹å»ºå¯èƒ½å¤±æ•—"
  exit 1
fi

# éƒ¨ç½²åˆ° GitHub Pages
echo "ğŸ“¤ æ­£åœ¨éƒ¨ç½²åˆ° GitHub Pages..."

if [[ $1 == '--user' ]]; then
  # å€‹äºº GitHub Pages ç›´æ¥æäº¤åˆ° master åˆ†æ”¯
  echo "ğŸ” éƒ¨ç½²åˆ°å€‹äºº GitHub Pages: $GITHUB_USERNAME.github.io"
  
  # ç¢ºä¿åœ¨ master åˆ†æ”¯
  if [[ $(git rev-parse --abbrev-ref HEAD) != "master" ]]; then
    echo "âŒ è«‹å…ˆåˆ‡æ›åˆ° master åˆ†æ”¯å¾Œå†éƒ¨ç½²"
    exit 1
  fi
  
  # æäº¤æ‰€æœ‰æ›´æ”¹
  echo "ğŸ“ æäº¤æ›´æ”¹..."
  git add .
  git commit -m "Deploy site update: $(date)" || { echo "âœ… æ²’æœ‰æ›´æ”¹éœ€è¦æäº¤"; }
  
  # æ¨é€åˆ°é ç«¯
  echo "ğŸ“¤ æ¨é€åˆ°é ç«¯..."
  git push origin master || { echo "âŒ æ¨é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„æ¬Šé™è¨­å®š"; exit 1; }
else
  # å°ˆæ¡ˆ GitHub Pages ä½¿ç”¨ gh-pages åˆ†æ”¯
  echo "ğŸ” éƒ¨ç½²åˆ°å°ˆæ¡ˆ GitHub Pages: $GITHUB_USERNAME.github.io/$GITHUB_REPONAME"
  
  # æª¢æŸ¥æ˜¯å¦æœ‰ gh-pages åˆ†æ”¯
  if ! git show-ref --verify --quiet refs/heads/gh-pages; then
    echo "ğŸ“ å‰µå»º gh-pages åˆ†æ”¯..."
    git branch gh-pages
  fi
  
  # è¤‡è£½ _site å…§å®¹åˆ°è‡¨æ™‚ç›®éŒ„
  rm -rf /tmp/_site
  cp -R _site /tmp/
  
  # åˆ‡æ›åˆ° gh-pages åˆ†æ”¯
  git checkout gh-pages
  
  # æ¸…ç©ºç•¶å‰ç›®éŒ„ï¼ˆä¿ç•™ .git æ–‡ä»¶å¤¾ï¼‰
  find . -maxdepth 1 ! -name .git -exec rm -rf {} \; 2>/dev/null || true
  
  # è¤‡è£½ _site å…§å®¹åˆ°ç•¶å‰ç›®éŒ„
  cp -R /tmp/_site/* .
  
  # æ·»åŠ  .nojekyll æ–‡ä»¶ï¼Œé˜²æ­¢ GitHub å˜—è©¦é‡æ–°æ§‹å»º
  touch .nojekyll
  
  # æäº¤æ›´æ”¹
  git add .
  git commit -m "Deploy site update: $(date)" || { echo "âœ… æ²’æœ‰æ›´æ”¹éœ€è¦æäº¤"; }
  
  # æ¨é€åˆ°é ç«¯
  git push origin gh-pages || { echo "âŒ æ¨é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„æ¬Šé™è¨­å®š"; exit 1; }
  
  # åˆ‡å›é–‹ç™¼åˆ†æ”¯
  git checkout $BRANCH
fi

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸŒ æ‚¨çš„ç¶²ç«™å·²ç™¼å¸ƒåˆ° https://$GITHUB_USERNAME.github.io/$([ "$1" != "--user" ] && echo "$GITHUB_REPONAME/")" 